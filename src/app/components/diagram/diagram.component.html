<div
  #canvas
  class="w-full h-full relative overflow-auto bg-white [background-image:radial-gradient(#e6e9ef_1px,transparent_1px)] [background-size:20px_20px] select-none"
  (dragover)="allowDrop($event)"
  (drop)="onDrop($event)"
>
  <ng-container *ngFor="let n of nodes">
    <div
      [id]="n.id"
      class="absolute group"
      [style.left.px]="leftFor(n)"
      [style.top.px]="topFor(n)"
      [style.zIndex]="(movingNode === n) ? 60 : 10"
      (pointerdown)="startMove(n, $event)"
      (click)="seleccionarNodo(n, $event)"
      style="touch-action: none;"
    >
      <div
        class="transition-transform duration-150 ease-out will-change-transform relative"
        [class.shadow-2xl]="n._dx !== undefined || n._dy !== undefined"
        [style.transform]="'translate(' + (n._dx ?? 0) + 'px,' + (n._dy ?? 0) + 'px)'"
      >
        <!-- Botón eliminar -->
        <button
          (click)="eliminarNodo(n.id); $event.stopPropagation();"
          class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition"
          title="Eliminar"
        >
          ✕
        </button>

        <!-- INICIO / FIN -->
        <div
          *ngIf="n.tipo === 'inicio' || n.tipo === 'fin'"
          class="w-16 h-16 rounded-full flex items-center justify-center text-white shadow-md"
          [ngClass]="n.tipo === 'inicio' ? 'bg-green-500' : 'bg-red-500'"
        >
          <div class="text-sm font-semibold">{{ n.tipo === 'inicio' ? 'Start' : 'End' }}</div>
        </div>

        <!-- ACTIVIDAD -->
        <div
          *ngIf="n.tipo === 'actividad'"
          class="w-[160px] h-[72px] rounded-lg bg-blue-500 border-2 border-blue-600 shadow-lg flex items-center justify-center px-3 relative handle"
        >
          <div class="flex items-center gap-2 text-white text-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-5 h-5 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.518-.878 3.316.92 2.438 2.438a1.724 1.724 0 001.065 2.573c1.757.426 1.757 2.924 0 3.35a1.724 1.724 0 00-1.065 2.573c.878 1.518-.92 3.316-2.438 2.438a1.724 1.724 0 00-2.573 1.065c-.426 1.757-2.924 1.757-3.35 0a1.724 1.724 0 00-2.573-1.065c-1.518.878-3.316-.92-2.438-2.438a1.724 1.724 0 00-1.065-2.573c-1.757-.426-1.757-2.924 0-3.35a1.724 1.724 0 001.065-2.573c-.878-1.518.92-3.316 2.438-2.438.973.563 2.147.126 2.573-1.065z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            <div>
              <div class="text-sm font-semibold text-white leading-tight">
                {{ n.label }}
              </div>
              <div
                *ngIf="n.data"
                class="text-xs text-white/80 mt-1 truncate"
              >
                {{ n.data.nombre }}
              </div>
            </div>
          </div>
        </div>


        <!-- GATEWAY -->
        <div
          *ngIf="n.tipo === 'gateway'"
          class="w-[100px] h-[100px] flex items-center justify-center relative handle"
        >
          <div class="relative">
            <div
              class="w-[80px] h-[80px] rotate-45 bg-yellow-400 border-2 border-yellow-500 shadow-lg rounded-sm"
            ></div>
            <div
              class="absolute inset-0 flex flex-col items-center justify-center -rotate-45 pointer-events-none space-y-1"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-6 h-6 text-white"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 4v6m0 0l-4 4m4-4l4 4M8 14h8"
                />
              </svg>
              <div class="text-sm font-semibold text-white text-center">
                {{ n.label }}
              </div>
            </div>
          </div>
        </div>


      </div>
    </div>
  </ng-container>
</div>

